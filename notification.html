<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MVP Notification</title>
    <!-- Add Bootstrap CSS link -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container">
<style>
    #buttonTableBody button {
        min-width:100px;
    }
</style>

<h2 class="mt-3">MVP Notification</h2>
<h6>99% Generated By ChatGPT</h6>

<form id="notificationForm" class="mt-3">
    <div class="mb-3">
        <label for="textInput" class="form-label">Enter Text:</label>
        <textarea id="textInput" class="form-control" name="text" rows="4" cols="50"></textarea>
    </div>

    <div class="mt-3">
        <!-- Collapsible Section -->
        <div class="accordion" id="channelPickerAccordion">
          <div class="accordion-item">
            <h2 class="accordion-header" id="channelPickerHeading">
              <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#channelPickerContent" aria-expanded="true" aria-controls="channelPickerContent">
                Channel Picker
              </button>
            </h2>
            <div id="channelPickerContent" class="accordion-collapse collapse show" aria-labelledby="channelPickerHeading">
              <div class="accordion-body">
                <!-- Table -->
                <table class="table">
                  <tbody id="buttonTableBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

    <div class="mb-3">
        <label for="timeInput" class="form-label">Time:</label>
        <input type="text" id="timeInput" class="form-control" name="time" placeholder="Enter time (e.g., 12:00 PM or 1/31/2024 12:00 PM)">
    </div>

    <button type="button" onclick="scheduleNotification()" class="btn btn-primary">Add Notification</button>
    |
    <button type="button" onclick="stepTime(-5)" class="btn btn-danger">-5</button>
    <button type="button" onclick="stepTime(-1)" class="btn btn-danger">-</button>
    <button type="button" onclick="getCurrentTime()" class="btn btn-secondary">Get Now</button>
    <button type="button" onclick="stepTime(1)" class="btn btn-success">+</button>
    <button type="button" onclick="stepTime(5)" class="btn btn-success">+5</button>
    |
    <button type="button" onclick="requestNotificationPermission()" class="btn btn-info">Enable Notifications</button>
</form>

<!-- Table to display queued notifications -->
<table class="table mt-4">
    <thead>
        <tr>
            <th scope="col">Notification</th>
            <th scope="col">Time (seconds)</th>
            <th scope="col">Action</th>
        </tr>
    </thead>
    <tbody id="notificationTableBody">
        <!-- Notification rows will be dynamically added here -->
    </tbody>
</table>

<script>
let notificationQueue = [];

function scheduleNotification() {
    var text = document.getElementById('textInput').value;
    var timeInput = document.getElementById('timeInput').value;

    if (text.trim() === "") {
        alert("Please enter text before scheduling the notification.");
        return;
    }

    if (!isValidTimeFormat(timeInput)) {
        alert("Please enter a valid time format (e.g., 12:00 PM or 1/31/2024 12:00 PM).");
        return;
    }

    var delayInSeconds = calculateDelayFromNow(timeInput);

    if (delayInSeconds <= 0) {
        alert("Please enter a future time.");
        return;
    }

    const notification = {
        text: text,
        timeInSeconds: delayInSeconds,
        id: new Date().getTime() // Unique ID for each notification
    };

    notificationQueue.push(notification);
    updateNotificationTable();

    notification.intervalId = setInterval(function() {
        notification.timeInSeconds -= 1;

        // If time is zero, clear the interval and show the notification
        if (notification.timeInSeconds === 0) {
            clearInterval(notification.intervalId);
            showNotification(notification);
        }
        updateNotificationTable(); // Update the table on each second
    }, 1000);
}

function showNotification(notification) {
    if (Notification.permission === "granted") {
        new Notification("Notifier", { body: notification.text });
    } else if (Notification.permission !== "denied") {
        Notification.requestPermission().then(function(permission) {
            if (permission === "granted") {
                new Notification("Notifier", { body: notification.text });
            }
        });
    }

    // Remove the notification from the queue
    notificationQueue = notificationQueue.filter(item => item.id !== notification.id);
}

function cancelNotification(id) {
    // Find the notification in the queue
    const canceledNotification = notificationQueue.find(item => item.id === id);

    // Clear the interval associated with the countdown
    clearInterval(canceledNotification.intervalId);

    // Remove the notification from the queue
    notificationQueue = notificationQueue.filter(item => item.id !== id);
    updateNotificationTable();
}

function updateNotificationTable() {
    const tableBody = document.getElementById('notificationTableBody');
    tableBody.innerHTML = "";

    notificationQueue.forEach(notification => {
        const row = tableBody.insertRow();
        const cell1 = row.insertCell(0);
        const cell2 = row.insertCell(1);
        const cell3 = row.insertCell(2);

        cell1.textContent = notification.text;

        // Create a dynamic span element for the time ticking down
        const timeSpan = document.createElement("span");
        timeSpan.textContent = notification.timeInSeconds;
        cell2.appendChild(timeSpan);

        const cancelButton = document.createElement("button");
        cancelButton.textContent = "Cancel";
        cancelButton.classList.add("btn", "btn-danger");
        cancelButton.addEventListener("click", function() {
            cancelNotification(notification.id);
        });

        cell3.appendChild(cancelButton);
    });
}

function isValidTimeFormat(time) {
    // Regular expression for validating time format (HH:mm AM/PM or MM/DD/YYYY HH:mm AM/PM or MM/DD/YYYY HH:mm:ss AM/PM)
    var regex = /^((1[0-2]|0?[1-9]):([0-5][0-9])(:([0-5][0-9]))? ?([APap][Mm])|(\d{1,2}\/\d{1,2}\/\d{4} )?(1[0-2]|0?[1-9]):([0-5][0-9]) ?([APap][Mm]))$/;
    return regex.test(time);
}

function calculateDelayFromNow(time) {
    var now = new Date();
    var splitTime = time.split(' ');

    if (splitTime.length === 2) {
        // If only time is provided, assume today's date
        splitTime.unshift(`${now.getMonth() + 1}/${now.getDate()}/${now.getFullYear()}`);
    }

    var datePart = splitTime[0].split('/');
    var hoursMinutes = splitTime[1].split(':');
    var year = datePart[2];
    var month = datePart[0] - 1; // Month is zero-based
    var day = datePart[1];
    var hours = parseInt(hoursMinutes[0]);
    var minutes = parseInt(hoursMinutes[1]);
    var seconds = +(hoursMinutes[2] ?? 0);
    var period = splitTime[2];

    if (period) {
        // Adjust hours for AM/PM
        if (period.toLowerCase() === 'pm' && hours !== 12) {
            hours += 12;
        } else if (period.toLowerCase() === 'am' && hours === 12) {
            hours = 0;
        }
    }

    var notificationTime = new Date(year, month, day, hours, minutes, seconds);

    // If the notification time is equal to or earlier than the current time, throw an alert error
    if (notificationTime <= now) {
        // Set the date to tomorrow if time is equal to or earlier than the current time
        notificationTime.setDate(now.getDate() + 1);
    }

    var delayInSeconds = Math.floor((notificationTime - now) / 1000);
    return delayInSeconds;
}

function getCurrentTime() {
    // Get the current date and time
    const now = new Date();

    // Format the time as "12:00 AM" or "01:30 PM"
    const formattedTime = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });

    // Set the value of the input element
    document.getElementById('timeInput').value = formattedTime;
}

function stepTime(step = 1) {
    // Get the value of the input element
    const currentTimeString = document.getElementById('timeInput').value;

    // Check if the input is empty
    if (currentTimeString.trim() === '') {
        // If empty, set the current date and time
        const now = new Date();
        const formattedTime = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        document.getElementById('timeInput').value = formattedTime;
    } else {
        // If not empty, proceed with incrementing the time
        // Parse the time string to a Date object
        const currentTime = new Date('2000-01-01 ' + currentTimeString);

        // Increment the time by 1 minute
        currentTime.setMinutes(currentTime.getMinutes() + step);

        // Format the incremented time and set the value of the input element
        const formattedTime = currentTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        document.getElementById('timeInput').value = formattedTime;
    }
}


function requestNotificationPermission() {
    Notification.requestPermission().then(function (permission) {
        if (permission === 'granted') {
            alert('Notifications are enabled!');
        } else if (permission === 'denied') {
            alert('Notifications are blocked. Please enable them in your browser settings.');
        }
    });
}

  // Function to populate the table with buttons
  function populateTable() {
    const tableBody = document.getElementById('buttonTableBody');
    const textField = document.getElementById('textInput');
    let buttonCount = 40;
    let buttonNumber = 1;

    // Create a new row
    let row = document.createElement('tr');

    while (buttonCount > 0) {
      // Add buttons to the row, up to 5 buttons per row
      const button = document.createElement('button');
      button.type = 'button'; // Prevents form submission
      button.className = 'btn btn-sm btn-primary';
      button.textContent = buttonNumber;
      button.addEventListener('click', (event) => {
        textField.value = `MVP @ Ch.${event.target.textContent}`;
        textField.focus();
      });

      const cell = document.createElement('td');
      cell.appendChild(button);
      row.appendChild(cell);

      buttonNumber++;
      buttonCount--;

      // Check if the row is full (5 buttons)
      if (row.children.length === 5 || buttonCount === 0) {
        tableBody.appendChild(row);
        
        // Create a new row for the next set of buttons
        row = document.createElement('tr');
      }
    }
  }

  // Call the function to populate the table on page load
  populateTable();
</script>

<!-- Add Bootstrap JS and Popper.js scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
