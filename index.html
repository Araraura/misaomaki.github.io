<style>
	.form-label {
		width:200px;
		display:inline-block;
	}

	.hidden {
		display: none !important;
	}

	.output {
		width: 200px;
		display: inline-block;
	}

	.destroy-output {
		background-color: grey;
		display: inline-block;
		color: white;
	}


	#starforce-output {
	  border-collapse: collapse;
	  width: 50%;
	}

	#starforce-output td, #starforce-output th {
	  border: 1px solid #ddd;
	}

	#starforce-output tr:nth-child(even){background-color: #f2f2f2;}

	#starforce-output tr:hover {background-color: #ddd;}

	#starforce-output th {
	  text-align: left;
	  background-color: #949494;
	  color: white;
	}
</style>

<style>
    .flex-container {
        display: flex;
        margin-bottom:10px;
    }

    .flex-item {
        border: 1px solid black;
        margin: 5px;
    }

    .flex-header {
        width: 100%;
        padding: 3px 0 3px 0;
        text-align: center;
        display: block;
        border-bottom: 1px solid black;
    }

    .stats {
        background-color: #afbcff;
    }

    .options {
        background-color: #ffafaf;
    }

    .options2 {
        background-color: #afffb9;
    }

    .item {
        background-color: #d98dff;
    }

    .item2 {
        background-color: #ffcd99;
    }

    .cost {
        background-color: #fdff99;
    }

    .hInfo {
        background-color: #d9ffaf;
    }
</style>

<div class="flex-container">
    <div class="flex-item" style="min-width:300px;">
        <span class="flex-header stats">Stats</span>
        <div id="stats">
            <span class="form-label" id="cheats">Stars:</span> <span id="l_s">0</span><br>
            <span class="form-label">Total Runs:</span> <span id="l_r">0</span><br>
            <span class="form-label">Total Success By Star Catch:</span> <span id="l_sc">0</span><br>
            <span class="form-label">Total Fails Within Star Catch:</span> <span id="l_sc_f">0</span><br>
            <span class="form-label">Total Fails:</span> <span id="l_f">0</span><br>
            <span class="form-label">Total Booms:</span> <span id="l_b">0</span><br>
            <span class="form-label">Total Safeguards 12-15:</span> <span id="l_sg12">0</span><br>
            <span class="form-label">Total Safeguards 15-17:</span> <span id="l_sg15">0</span><br>
            <span class="form-label">Total Passed 15:</span> <span id="l_p15">0</span><br>
            <span class="form-label">Total Passed 20:</span> <span id="l_p20">0</span><br>
            <span class="form-label">Total Cost:</span> <span id="l_c">0</span> <br>
            <span class="form-label">Total Safeguard Cost 12-15:</span> <span id="l_c_sg12">0</span> <br>
            <span class="form-label">Total Safeguard Cost 15-17:</span> <span id="l_c_sg15">0</span>
        </div>
    </div>
    <div class="flex-item">
        <span class="flex-header options">Options</span>
        <label for="cb_sc"><input type="checkbox" id="cb_sc" class="sc" title="Assumption: 5% increased multiplicatively"> Star Catch</label> <br>
        <label for="cb_sf12"><input type="checkbox" id="cb_sf12" class="sf"> Safeguard from 12 to 15</label> <br>
        <label for="cb_sf15"><input type="checkbox" id="cb_sf15" class="sf"> Safeguard from 15 to 17</label> <br>
        <hr>
        <label for="cb_e_0o"><input type="radio" id="cb_e_0o" name="mvp_dc" class="ev mvp-dc" value="0" checked> No Discount</label> <br>
        <label for="cb_e_3o"><input type="radio" id="cb_e_3o" name="mvp_dc" class="ev mvp-dc" value="0.03"> Silver MVP (3% off)</label> <br>
        <label for="cb_e_5o"><input type="radio" id="cb_e_5o" name="mvp_dc" class="ev mvp-dc" value="0.05"> Gold MVP (5% off)</label>  <br>
        <label for="cb_e_10o"><input type="radio" id="cb_e_10o" name="mvp_dc" class="ev mvp-dc" value="0.10"> Diamond MVP (10% off)</label>
        <hr>
        <label for="cb_e_30o"><input type="checkbox" id="cb_e_30o" class="ev"> 30% off event</label>
        <br>
        <label for="cb_e_mod5s"><input type="checkbox" id="cb_e_mod5s" class="ev"> 100% 5/10/15</label>
    </div>
    <div class="flex-item hidden" id="cheat_panel">
        <span class="flex-header options2">Fluff</span>
        <label for="cb_ch_sf17"><input type="checkbox" id="cb_ch_sf17" class="ev ch"> Safeguard from 17 to 20</label> <br>
        <label for="cb_ch_sf20"><input type="checkbox" id="cb_ch_sf20" class="ev ch"> Safeguard from 20 to 22</label> <br>
        <label for="cb_ch_sf22"><input type="checkbox" id="cb_ch_sf22" class="ev ch"> Safeguard from 22 to 25</label> <br>
        <label for="cb_ch_showq"><input type="checkbox" id="cb_ch_showq" class="ch" title="Show the Pseudorandom Number generated to determine the starforce outcome."> Show PRN</label> <br>
    </div> 
</div>

<div class="flex-container">
    <div class="flex-item" style="min-width:200px;">
        <span class="flex-header item">Starforce Enhancement</span>
        Item Level: <select id="itemLevel">
            <option value="150">150</option>
            <option value="160">160</option>
            <option value="200">200</option>
            <option value="-150">Superior</option>
        </select>

        <br><br>

        Start At: <input type="number" min="10" max="25" id="numStart" value="10"> 
        <button id="btnNew">New Item</button>
    </div>
    <div class="flex-item">
        <span class="flex-header item2">Auto Enhancement</span>
        
        <input type="number" min="11" max="25" id="num" value="22">
        <button id="btnGoToStar">Go To Star</button> <button id="btnStop" class="hidden">Stop</button>
        <br><br>
        <label for="cbHeuristic" id="heur" class="hidden">
            <input type="checkbox" id="cbHeuristic"> Use Heuristic Enhancement <span id="h_info" style="cursor:pointer;" title='Uses an alternative starforcing method. The current method is to starforce as you would in game, just quickly.
This method assumes you have an infinite number of 22-star items. Booming the item means you toss the trace and start again with a new 22-star item. 
Once the desired star is reached, the code goes back and runs starforcing for each boom, going from 12->22. One run will go from {start}->22 to account for your first run at the desired start level. 
While faster, it does not update the table or show the starforce data on a per-star basis.
Run 25 at your own peril.'>[?]</span>
        </label>
    </div>
</div>

<div class="flex-container" id="star_cost">
    <div class="flex-item" style="min-width:500px;">
        <span class="flex-header cost">Star Cost</span>
        <div id="currentStats">
            <span class="form-label">Next Star:</span><span id="c_ns">0</span><br>
            <span class="form-label">Success:</span><span id="c_s">0</span><br>
            <span class="form-label">Fail:</span><span id="c_f">0</span><br>
            <span class="form-label">Destroy:</span><span id="c_d">0</span><br>
            <span class="form-label">Cost:</span><span id="c_c">0</span><br>
            <span class="form-label">Star Catch:</span><span id="c_sc">No</span><br>
        </div>
        <button id="btn" style="width:100%;">Enhance</button>
    </div>
</div>

<hr>
<button id="lineChartShowHide">Show Graph</button>
<canvas id="lineChart" width="400px" height="100px" class="hidden"></canvas>
<table id="starforce-output" style="width:45%;min-width:600px;">
	<thead>
		<th style="width:5%">Attempt</th>
		<th style="width:5%">Star</th>
		<th style="width:35%">Result</th>
        <th>Total Cost</th>
        <th style="width:10%" class="ch-row hidden">PRN</th>
	</thead>
	<tbody id="t-output">
		
	</tbody>
<table>
    
<script
  src="https://code.jquery.com/jquery-3.4.1.min.js"
  integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
  crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.bundle.min.js"></script>


<script>
$(function() {
    var enhanceBtn = $("#btn");

    Number.prototype.toNumber = function() {
        return this.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    var level = 150;

    var numStart = $("#numStart");
    var itemLevel = $("#itemLevel");
    var btnGoToStar = $("#btnGoToStar");
    var numBtn = $("#num");

    var graphShown = false;
    $("#lineChartShowHide").on("click", function() {
        var graph = $("#lineChart");
        var _this = $(this);
        if (graphShown) {
            graph.addClass("hidden");
            _this.html("Show Graph");
            graphShown = false;
        } else {
            graph.removeClass("hidden");
            _this.html("Hide Graph");
            graphShown = true;
        }
    });

    itemLevel.on("change", function() {
        level = +$(this).val();

        if (level === -150) {
        	numStart.val(1).attr("max", 15);
        	$(".sf,.ev").prop("disabled", true).prop("checked", false);
        	numBtn.val(12).attr("max", 15);
        } else {
        	numStart.val(10).attr("max", 25);
        	$(".sf,.ev").prop("disabled", false);
        	numBtn.val(22).attr("max", 25);
        }

        var thisItem = {
            level: level,
            currStar: 10
        };

        getNextStar(thisItem);
        $("#btnNew").trigger("click");
        numBtn.trigger("change");
    });

    var mc = "";
    var currMax = 0;
    var generateLineGraph = function(item) {
        var graphData = item.sfData.slice(Math.max(item.sfData.length - 500, 1)).map((a) => {return {x: a.id, y: a.current_star}});

        var isSuperior = itemLevel.val() == -150;

        var min = 10;
        var max = 25;

        if (isSuperior) {
            min = 1;
            max = 15;
        }

        if (mc === "" || currMax !== max) {
            var ctx = $("#lineChart");
            mc = new Chart(ctx, {
                type: "scatter",
                data: {
                    datasets: [{
                        label: "Starforce (Last 500 Attempts)",
                        showLine: true,
                        data: graphData
                    }]
                },
                options: {
                    responsive: true,
                    animations: false,
                    elements: {
                        point: {
                            radius: 0
                        }
                    },
                    tooltips: {
                        mode: "index",
                        intersect: false
                    },
                    hover: {
                        mode: "nearest",
                        intersect: true
                    },
                    scales: {
                        yAxes: [{
                            ticks: {
                                min: min,
                                max: max,
                                stepSize: 1
                            }
                        }],
                        xAxes: [{
                            ticks: {
                                stepSize: 1
                            }
                        }]
                    }
                }
            });

            currMax = max;
        } else {
            mc.config.data.datasets[0].data = graphData;
            mc.update();
        }
    }

    generateLineGraph({sfData: []});

    var generateTable = function(item, startAt = 0) {
    	var data = item.sfData;

        var unhideRow = $("#cb_ch_showq").prop("checked");

    	var tbody = "";
    	for (let i = data.length - 1; i >= startAt; --i) {
    		let _d = data[i];
    		var thisResult = "";

    		switch (_d.type) {
    			case 1: 
                    thisResult = '<span style="color:green">Success!</span>';
    			break;
    			case 2:
    				thisResult = '<span style="color:red">Failed</span>';
    			break;
    			case 3:
    				thisResult = '<span style="color:green">Success (Star Catch)!</span>'; 
    			break;
    			case 4:
    				thisResult = '<span style="color:red">Failed (Star Catch)!</span>'; 
    			break;
    			case 5:
    				thisResult = '<span style="color:white">Destroyed!</span>'; 
    			break;
    			case 6:
    				thisResult = '<span style="color:white">Safeguard!</span>'; 
    			break;
    			case 7:
    				thisResult = '<span style="color:white">Safeguard!</span>'; 
    			break;
                case 8:
                    thisResult = '<span style="color:white">Safeguard!</span>'; 
                break;
                case 9:
                    thisResult = '<span style="color:white">Safeguard!</span>'; 
                break;
                case 10:
                    thisResult = '<span style="color:white">Safeguard!</span>'; 
                break;
            }
            
    		if (_d.is_chance_time) {
    			tbody += `
    				<tr>
    					<td colspan="100%" style="text-align:center;background-color:white;">
    						Chance Time!
    					</td>
    				</tr>
    			`;
    		}

    		var bgColor = "none";
    		var color = "black";

    		if (_d.current_star === 22) {
    			bgColor = "#0070dd";
    			color = "white";
    		} else if (_d.current_star === 23) {
    			bgColor = "#a335ee";
    			color = "white";
    		} else if (_d.current_star === 24) {
    			bgColor = "#ff8000";
    			color = "white";
    		} else if (_d.current_star === 25) {
    			bgColor = "#00f70a";
    			color: "white";
    		}

    		tbody += `
    			<tr>
    				<td>${i + 1}</td>
    				<td style="background-color:${bgColor};color:${color}">${_d.current_star}</td>
    				<td ${_d.type >= 5 && _d.type <= 10 ? 'style="background-color:grey"' : ''}>${thisResult}</td>
                    <td>${_d.current_total_cost}</td>
                    <td class="ch-row ${unhideRow ? "" : "hidden"}">${_d.q}</td>
    			</tr>
    		`;
    	}

    	if (startAt === 0) {
    		$("#t-output").html(tbody);
    	} else {
    		$("#t-output").prepend(tbody);
    	}
    };

    var star_cost = $("#star_cost");
    var getNextStar = function(o, updStats = false) {
        var level = o.level;
        var star = o.currStar;
        var chanceTime = o.chancetime;
        star_cost.removeClass("hidden");
        if (star === 25) {
            star_cost.addClass("hidden");
            return false;
        }

        var thisSf = sf["s" + level];
        var _sf1 = thisSf.filter(a => {
            return a.level === star
        })[0];


        var sf12 = $("#cb_sf12").prop("checked");
        var sf15 = $("#cb_sf15").prop("checked");

        var sf17 = $("#cb_ch_sf17").prop("checked");
        var sf20 = $("#cb_ch_sf20").prop("checked");
        var sf22 = $("#cb_ch_sf22").prop("checked");

        var sc = $("#cb_sc").prop("checked");
        var _mvp = $(".mvp-dc:checked");
        var mvp = _mvp.length > 0;
        var mvpVal = +_mvp.val();
        var o30 = $("#cb_e_30o").prop("checked");
        var mod5s = $("#cb_e_mod5s").prop("checked");

        var isSafe = false;
        isSafe = isSafe || (sf12 && star >= 12 && star < 15);
        isSafe = isSafe || (sf15 && star >= 15 && star < 17);
        isSafe = isSafe || (sf17 && star >= 17 && star < 20);
        isSafe = isSafe || (sf20 && star >= 20 && star < 22);
        isSafe = isSafe || (sf22 && star >= 22 && star < 25);

        var is100 = (mod5s && star % 5 === 0 && star < 20) || chanceTime >= 2;
        var effectiveCost = parseFloat((_sf1.cost - (o30 ? _sf1.cost * 0.3 : 0) - (mvp && star < 17 ? _sf1.cost * mvpVal : 0)).toFixed(0)) + (isSafe && !is100 ? _sf1.cost : 0);

        var success = parseFloat(_sf1.success * 100).toFixed(1) + "%";
        var fail = parseFloat(_sf1.fail * 100).toFixed(1) + "%";
        var destroy = parseFloat(_sf1.destroy * 100).toFixed(1) + "%";

        if (is100) {
            success = '<strike>' + success + '</strike> 100%';
            fail = '0%';
            destroy = '0%';
        }

        //update next star value
        $("#c_ns").html(star + 1);
        $("#c_s").html(success);
        $("#c_f").html(fail);
        $("#c_d").html(destroy);
        $("#c_c").html(effectiveCost.toNumber());
        $("#c_sc").html(sc ? "Yes" : "No");

        //update stats
        if (updStats) {
            update_stats(o);
        }
    };

    var update_stats = function (o) {
        $("#l_s").html(o.currStar);
        $("#l_r").html(o.totRuns);
        $("#l_sc").html(o.totSc);
        $("#l_sc_f").html(o.totScF);
        $("#l_f").html(o.totFail);
        $("#l_b").html(o.totBoom);
        $("#l_sg12").html(o.totSg12);
        $("#l_sg15").html(o.totSg15);
        $("#l_p15").html(o.totp15);
        $("#l_p20").html(o.totp20);
        $("#l_c").html(o.totalCostFormatted);
        $("#l_c_sg12").html(o.totCostSg12.toNumber());
        $("#l_c_sg15").html(o.totCostSg15.toNumber());
    }

    var star = function(o, updStats = true) {
        this.currStar = o.star || 1;
        this.chanceTime = 0;
        this.currRun = 0;
        this.level = o.level || "150";
        this.sf = sf["s" + this.level];
        this.totalCost = 0;
        this.totalCostFormatted = 0;
        this.totBoom = 0;
        this.totFail = 0;
        this.totRuns = 0;
        this.totp15 = 0;
        this.totp20 = 0;
        this.totSg12 = 0;
        this.totSg15 = 0;
        this.totSg17 = 0;
        this.totSg20 = 0;
        this.totSg22 = 0;
        this.totCostSg12 = 0;
        this.totCostSg15 = 0;
        this.totSc = 0;
        this.totScF = 0;

        this._prev15 = true;
        this._prev20 = true;

        this._private = {
            fail: function(_this) {
                _this.totFail += 1;
                if (_this.currStar !== 1) {
                    if (_this.currStar % 5 !== 0 || _this.level === -150) {
                        _this.currStar -= 1;
                        _this.chanceTime += 1;
                    }
                }
            }
        };

        this.sfData = [];

        this.starforce = function(_o) {
            this.totRuns += 1;
            _o = $.extend({}, _o);

            var _d = {
            	type: 0,
            	current_star: 0,
            	total_current_cost: 0,
            	current_cost: 0,
            	q: 0,
            	is_chance_time: false
            };

            this.currRun += 1;
            _d.id = this.currRun;

            var ran = 0;
            var isChance = false;

            if (this.chanceTime >= 2) {
                this.chanceTime = 0;
                isChance = true;
            } else {
                ran = Math.random();
                _d.q = ran;
            }

            var message = "";

            var boomLevel = 12;

            if (this.level === -150) {
            	boomLevel = 1;
            }

            var _sf = this.sf.filter(a => {
                return a.level === this.currStar
            })[0];

            //TODO: make global variable and update them with event
            var sf12 = $("#cb_sf12").prop("checked");
            var sf15 = $("#cb_sf15").prop("checked");

            var sf17 = $("#cb_ch_sf17").prop("checked");
            var sf20 = $("#cb_ch_sf20").prop("checked");
            var sf22 = $("#cb_ch_sf22").prop("checked");

            var sc = $("#cb_sc").prop("checked");
            var _mvp = $(".mvp-dc:checked");
            var mvp = _mvp.length > 0;
            var mvpVal = +_mvp.val();
            var o30 = $("#cb_e_30o").prop("checked");
            var mod5s = $("#cb_e_mod5s").prop("checked");

            var isSafe12 = sf12 && this.currStar >= 12 && this.currStar < 15;
            var isSafe15 = sf15 && this.currStar >= 15 && this.currStar < 17;
            var isSafe17 = sf17 && this.currStar >= 17 && this.currStar < 20;
            var isSafe20 = sf20 && this.currStar >= 20 && this.currStar < 22;
            var isSafe22 = sf22 && this.currStar >= 22 && this.currStar < 25;

            var isSafe = isSafe12 || isSafe15 || isSafe17 || isSafe20 || isSafe22;

            var is100 = (mod5s && this.currStar % 5 === 0 && this.currStar < 20) || isChance;

            var currCost = _sf.cost;

            var effectiveCost = parseFloat((currCost - (o30 ? currCost * 0.3 : 0) - (mvp && this.currStar < 17 ? currCost * mvpVal : 0)).toFixed(0)) + (isSafe && !is100 ? currCost : 0);

            this.totalCost += effectiveCost;
            _d.current_cost = effectiveCost;
            
            _d.current_total_cost = this.totalCost.toNumber();;
            this.totalCostFormatted = _d.current_total_cost;
            var sg12Cost = 0;
            var sg15Cost = 0;

            if (isSafe12 && !is100) {
                this.totCostSg12 += currCost;
            }

            if (isSafe15 && !is100) {
                this.totCostSg15 += currCost;
            }

            var scSuccess = _sf.success * 1.05;


            if (this.level !== -150 && mod5s && this.currStar % 5 === 0 && this.currStar < 20) {
                ran = 0;
            }

            if (ran !== 0 && ran <= _sf.destroy) {
                if (isSafe12) {
                    this._private.fail(this);
                    this.totSg12 += 1;
                    _d.type = 6; //destroyed, safeguard 12-15
                } else if (isSafe15) {
                    this._private.fail(this);
                    this.totSg15 += 1;
                    _d.type = 7;  //destroyed, safeguard 15-17
                } else if (isSafe17) {
                    this._private.fail(this);
                    this.totSg17 += 1;
                    _d.type = 8;  //destroyed, safeguard 17-20
                } else if (isSafe20) {
                    this._private.fail(this);
                    this.totSg20 += 1;
                    _d.type = 9;  //destroyed, safeguard 20-22
                } else if (isSafe22) {
                    this._private.fail(this);
                    this.totSg22 += 1;
                    _d.type = 10;  //destroyed, safeguard 22-25
                } else {
                    this.currStar = boomLevel;
                    this.totBoom += 1; 
                    this.chanceTime = 0;
                    this._prev15 = true;
                    this._prev20 = true;
                    _d.type = 5; //destroyed
                }
            } else if (ran <= _sf.destroy + _sf.success) {
                this.currStar += 1;
                 _d.type = 1; //success
                this.chanceTime = 0;
            } else if (ran <= _sf.destroy + scSuccess) {
            	if (sc) {
	                this.currStar += 1;
	                this.totSc += 1;
	                _d.type = 3; //star catch success
	                this.chanceTime = 0;
            	} else {
            		this.totScF += 1;
            		_d.type = 4; //fail, but within star catch
            		this._private.fail(this);
            	}
            } else {
                this._private.fail(this);
                 _d.type = 2; //fail
            }

            if (this.currStar >= 15 && this._prev15) {
                this.totp15 += 1;
                this._prev15 = false;
            }

            if (this.currStar >= 20 && this._prev20) {
                this.totp20 += 1;
                this._prev20 = false;
            }

            if (this.currStar === 0) {
            	this.currStar = 1;
            }

            if (updStats) {
                getNextStar(this, true);
            }

            if (this.chanceTime === 2) {
            	_d.is_chance_time = true; //chance time
            }

            _d.current_star = this.currStar;
            this.sfData.push(_d);

            if (typeof _o.cb_end === 'function') {
                _o.cb_end();
            }

            if (!updStats) {
                return _d;
            }
        }
    };

    var start = +numStart.val();
    var item = new star({
        star: start,
        level: level
    });
    getNextStar(item);

    enhanceBtn.on("click", function() {
        item.starforce();

        generateTable(item, item.sfData.length - 1);
        generateLineGraph(item);
    });

    var n = 0;
    var max_n = 1000000;
    var n_stop = false;
    $("#btnNew").on("click", function() {
        n = 0;
        n_stop = true;
        var start = +numStart.val();
        item = new star({
        	level: level,
            star: start
        });
        getNextStar(item);
        generateLineGraph(item);
        $("#t-output").html("");
    });

    var btnStop = $("#btnStop");
    var cbHeuristicContainer = $("#heur");
    var cbHeuristic = $("#cbHeuristic");
    btnStop.on("click", function() {
        n_stop = true;
        setTimeout(function() {
            $("#output").prepend("Stopped.<br>");
        }, 100);

        resetGoToButton();
    });

    numBtn.on("change", function() {
        var val = +$(this).val();
        cbHeuristic.prop("checked", false);

        if (val >= 23) {
            cbHeuristicContainer.removeClass("hidden");
        } else {
            cbHeuristicContainer.addClass("hidden");
        }

        if (val >= 24) {
            btnStop.removeClass("hidden");
        } else {
            btnStop.addClass("hidden");
        }
    });

    $("body").on("keydown", function(e) {
        if (e.which === 13 || e.keyCode === 13) {
            e.preventDefault();
            enhanceBtn.trigger("click");
        }
    });

    $("#cbHeuristic").on("click", function(e) {
        if (e.target.checked) {
            btnStop.addClass("hidden");
        } else {
            btnStop.removeClass("hidden");
        }
    });

    var recursive_starforce = function(v, done) {
        item.starforce({
            cb_end: function() {
                if ((n <= max_n && item.currStar <= v) && !n_stop) {
                    setTimeout(function() {
                        recursive_starforce(v, done);
                    }, 1);

                    n += 1;

                    generateTable(item, item.sfData.length - 1);
                    generateLineGraph(item);

                    if (n > max_n) {
                        setTimeout(function() {
                            $("#output").prepend("Unable to get to this star in " + max_n + " tries.<br>");
                        }, 100);

                        if (typeof done === 'function') {
                            done();
                        }

                        n_stop = true;
                    }
                } else {
                    if (typeof done === 'function') {
                        done();
                    }
                }
                if (n_stop) {
                    n_stop = false;
                }
            }
        });
    }

    function resetGoToButton() {
        btnGoToStar.prop("disabled", false).html("Go To Star");
    }

    var heuristic = {};
    var heuristic_end_star = 0;
    var runs = 0;
    function recursiveHeuristic(st) {
        var level = itemLevel.val();

        if (heuristic_end_star === st) {
            heuristic_done(st);
            return false;
        }

        runs += 1;

        if (typeof heuristic["t" + st] === 'undefined') {
            heuristic["t" + st] = {
                runs: 0,
                fails: 0,
                fail_starcatch: 0,
                success_starcatch: 0,
                destroy: 0,
                cost: 0
            };
        }

        var hItem = new star({
            star: st,
            level: level
        }, false);

        hItem.starforce();

        var sf = hItem.sfData[0];
        var type = sf.type;
        var currstar = sf.current_star;
        var cost = hItem.totalCost;
        

        var estar = 0;
        //fail
        heuristic["t" + st].cost += cost;
        heuristic["t" + st].runs += 1;
        if (sf.type === 2 || sf.type === 4) {
            if (sf.type === 4) {
                heuristic["t" + st].fail_starcatch += 1;
            }
            heuristic["t" + st].fails += 1;
            estar = currstar;
        //destroyed
        } else if (sf.type === 5) {
            heuristic["t" + st].destroy += 1;
            estar = 22;
        } else {
        //success
            if (sf.type === 3) {
                heuristic["t" + st].success_starcatch += 1;
            }
            estar = currstar;
        }

        //anti-call stack exceed
        if (runs > 2000) {
            setTimeout(function() {recursiveHeuristic(estar);},0);
            runs = 0;
        } else {
            recursiveHeuristic(estar);
        }
    }

    var heuristic_item_backfilled = {
        totRuns: 0,
        totSc: 0,
        totScF: 0,
        totFail: 0,
        totBoom: 0,
        totSg12: 0,
        totSg15: 0,
        totp15: 0,
        totp20: 0,
        totalCost: 0,
        totCostSg12: 0,
        totCostSg15: 0
    };
    var heuristic_done = function(st) {
        var totalRuns = 0;
        var failStarcatch = 0;
        var successStarcatch = 0;
        var totalCost = 0;
        var totalDestroy = 0;
        var totalFail = 0;
        for (var i in heuristic) {
            totalRuns += heuristic[i].runs;
            failStarcatch += heuristic[i].fail_starcatch;
            successStarcatch += heuristic[i].success_starcatch;
            totalCost += heuristic[i].cost;
            totalDestroy += heuristic[i].destroy;
            totalFail += heuristic[i].fails;
        }
        
        var heuristicItem = {
            currStar: st,
            totRuns: totalRuns,
            totSc: successStarcatch,
            totScF: failStarcatch,
            totBoom: totalDestroy,
            totalCost: totalCost,
            totFail: totalFail,
            totCostSg12: 0,
            totCostSg15: 0
        };

        //reset heuristic item
        heuristic_item_backfilled = {
            totRuns: 0,
            totSc: 0,
            totScF: 0,
            totFail: 0,
            totBoom: 0,
            totSg12: 0,
            totSg15: 0,
            totp15: 0,
            totp20: 0,
            totalCost: 0,
            totCostSg12: 0,
            totCostSg15: 0
        };

        for (var j in heuristic_item_backfilled) {
            heuristic_item_backfilled[j] += heuristicItem[j] || 0;
        }

        btnGoToStar.html("Beginning backfill...");
        setTimeout(function() {
            heuristic_backfill_init(totalDestroy, st);
        }, 0);
    }

    var heuristic_backfill_init = function(booms, st) {
        var initItem = new star({
            star: start,
            level: level
        }, false);

        while (initItem.currStar < 22) {
            initItem.starforce()
        }

        for (var j in heuristic_item_backfilled) {
            heuristic_item_backfilled[j] += initItem[j];
        }

        if (booms > 0) {
            for (var i = 0; i < booms; ++i) {
                setTimeout(function(_i) {
                    btnGoToStar.html("Beginning backfill..." + parseFloat(((_i + 1)/ booms) * 100).toFixed(1) + "%");
                    heuristic_backfill(booms, st, _i);
                }, 0, i);
            }
        } else {
            heuristic_backfill_done(st, true);
        }
    }

    var heuristic_backfill = function(booms, st, i) {
        var hbfItem = new star({
            star: 12,
            level: level
        }, false);

        while (hbfItem.currStar < 22) {
            hbfItem.starforce()
        }

        for (var j in heuristic_item_backfilled) {
            heuristic_item_backfilled[j] += hbfItem[j];
        }

        heuristic_backfill_done(st, i + 1 === booms);
    }

    function heuristic_backfill_done (st, done) {
        heuristic_item_backfilled.currStar = st;
        heuristic_item_backfilled.totalCostFormatted = heuristic_item_backfilled.totalCost.toNumber();
        heuristic_item_backfilled.level = level;
       
        update_stats(heuristic_item_backfilled);
        
        if (done) {
            item = new star({
                star: st,
                level: level
            });
            getNextStar(heuristic_item_backfilled);
            resetGoToButton(); 
        }
    }

    btnGoToStar.on("click", function() {
        var _this = $(this);
        _this.prop("disabled", true).html("Processing...");
        var value = +numBtn.val();

        var isH = $("#cbHeuristic").prop("checked");
        if (isH) {
            runs = 0;
            $("#t-output").html("");
            _this.html("Running heuristic...");
            //reset heuristic
            heuristic = {};
            heuristic_end_star = value;
            recursiveHeuristic(value - 1);
            return false;
        }

        
        n = 0;
        n_stop = false;

        if (isNaN(value)) {
            return false;
        }

        var currVal = item.currStar;

        if (value < 24) {
            while (item.currStar < value) {
                item.starforce();
                currVal = item.currStar;
            }

            generateTable(item);
            generateLineGraph(item);
            resetGoToButton();
        } else {
            recursive_starforce(value, function() {
                resetGoToButton();
            });
        }
    });

    $(".sf,.sc,.ev").on("click", function() {
        getNextStar(item);
    });

    $("#cheats").on("click", function() {
        $("#cheat_panel").toggleClass("hidden");

        $(".ch").prop("checked", false);

        $(".ch").trigger("change");
    });

    $("#cb_ch_showq").on("change", function(e) {
        if (e.target.checked) {
            $(".ch-row").removeClass("hidden");
        } else {
            $(".ch-row").addClass("hidden");
        }
    });

    var h_info_container = $("#h_info_container");
    $("#h_info").on("mouseover", function() {
        h_info_container.removeClass("hidden");
    }).on("mouseout", function() {
        h_info_container.addClass("hidden");
    });
});

var sf = {
    s140: [], //add 140 data here
    s150: [{
        level: 10,
        success: 0.45,
        fail: 0.55,
        destroy: 0,
        cost: 5470800
    }, {
        level: 11,
        success: 0.35,
        fail: 0.65,
        destroy: 0,
        cost: 6919400
    }, {
        level: 12,
        success: 0.30,
        fail: 0.693,
        destroy: 0.007,
        cost: 8588400
    }, {
        level: 13,
        success: 0.30,
        fail: 0.686,
        destroy: 0.014,
        cost: 10490600
    }, {
        level: 14,
        success: 0.30,
        fail: 0.686,
        destroy: 0.014,
        cost: 12638500
    }, {
        level: 15,
        success: 0.30,
        fail: 0.679,
        destroy: 0.021,
        cost: 50144700
    }, {
        level: 16,
        success: 0.30,
        fail: 0.679,
        destroy: 0.021,
        cost: 59062500
    }, {
        level: 17,
        success: 0.30,
        fail: 0.679,
        destroy: 0.021,
        cost: 68918300
    }, {
        level: 18,
        success: 0.30,
        fail: 0.672,
        destroy: 0.028,
        cost: 87000300
    }, {
        level: 19,
        success: 0.30,
        fail: 0.672,
        destroy: 0.028,
        cost: 99923200
    }, {
        level: 20,
        success: 0.30,
        fail: 0.63,
        destroy: 0.07,
        cost: 125391900
    }, {
        level: 21,
        success: 0.30,
        fail: 0.63,
        destroy: 0.07,
        cost: 142173300
    }, {
        level: 22,
        success: 0.03,
        fail: 0.776,
        destroy: 0.194,
        cost: 160303000
    }, {
        level: 23,
        success: 0.02,
        fail: 0.686,
        destroy: 0.294,
        cost: 179823500
    }, {
        level: 24,
        success: 0.01,
        fail: 0.594,
        destroy: 0.396,
        cost: 200777000
    }],
    s160: [{
        level: 10,
        success: 0.45,
        fail: 0.55,
        destroy: 0,
        cost: 6639400
    }, {
        level: 11,
        success: 0.35,
        fail: 0.65,
        destroy: 0,
        cost: 8397300
    }, {
        level: 12,
        success: 0.30,
        fail: 0.693,
        destroy: 0.007,
        cost: 10422900
    }, {
        level: 13,
        success: 0.30,
        fail: 0.686,
        destroy: 0.014,
        cost: 12731500
    }, {
        level: 14,
        success: 0.30,
        fail: 0.686,
        destroy: 0.014,
        cost: 15338200
    }, {
        level: 15,
        success: 0.30,
        fail: 0.679,
        destroy: 0.021,
        cost: 60856900
    }, {
        level: 16,
        success: 0.30,
        fail: 0.679,
        destroy: 0.021,
        cost: 71679800
    }, {
        level: 17,
        success: 0.30,
        fail: 0.679,
        destroy: 0.021,
        cost: 83641100
    }, {
        level: 18,
        success: 0.30,
        fail: 0.672,
        destroy: 0.028,
        cost: 105585900
    }, {
        level: 19,
        success: 0.30,
        fail: 0.672,
        destroy: 0.028,
        cost: 121269600
    }, {
        level: 20,
        success: 0.30,
        fail: 0.63,
        destroy: 0.07,
        cost: 152179100
    }, {
        level: 21,
        success: 0.30,
        fail: 0.63,
        destroy: 0.07,
        cost: 172545500
    }, {
        level: 22,
        success: 0.03,
        fail: 0.776,
        destroy: 0.194,
        cost: 194548300
    }, {
        level: 23,
        success: 0.02,
        fail: 0.686,
        destroy: 0.294,
        cost: 218239000
    }, {
        level: 24,
        success: 0.01,
        fail: 0.594,
        destroy: 0.396,
        cost: 243668700
    }],
    s200: [{
        level: 10,
        success: 0.45,
        fail: 0.55,
        destroy: 0,
        cost: 12966500
    }, {
        level: 11,
        success: 0.35,
        fail: 0.65,
        destroy: 0,
        cost: 16400100
    }, {
        level: 12,
        success: 0.30,
        fail: 0.693,
        destroy: 0.007,
        cost: 20356300
    }, {
        level: 13,
        success: 0.30,
        fail: 0.686,
        destroy: 0.014,
        cost: 24865300
    }, {
        level: 14,
        success: 0.30,
        fail: 0.686,
        destroy: 0.014,
        cost: 29956500
    }, {
        level: 15,
        success: 0.30,
        fail: 0.679,
        destroy: 0.021,
        cost: 118860200
    }, {
        level: 16,
        success: 0.30,
        fail: 0.679,
        destroy: 0.021,
        cost: 139998700
    }, {
        level: 17,
        success: 0.30,
        fail: 0.679,
        destroy: 0.021,
        cost: 163360500
    }, {
        level: 18,
        success: 0.30,
        fail: 0.672,
        destroy: 0.028,
        cost: 206221600
    }, {
        level: 19,
        success: 0.30,
        fail: 0.672,
        destroy: 0.028,
        cost: 236853700
    }, {
        level: 20,
        success: 0.30,
        fail: 0.63,
        destroy: 0.07,
        cost: 297223800
    }, {
        level: 21,
        success: 0.30,
        fail: 0.63,
        destroy: 0.07,
        cost: 337002000
    }, {
        level: 22,
        success: 0.03,
        fail: 0.776,
        destroy: 0.194,
        cost: 379976100
    }, {
        level: 23,
        success: 0.02,
        fail: 0.686,
        destroy: 0.294,
        cost: 426247000
    }, {
        level: 24,
        success: 0.01,
        fail: 0.594,
        destroy: 0.396,
        cost: 475914500
    }],
    "s-150": [{
        level: 1,
        success: 0.50,
        fail: 0.50,
        destroy: 0,
        cost: 55832200
    }, {
        level: 2,
        success: 0.45,
        fail: 0.55,
        destroy: 0,
        cost: 55832200
    }, {
        level: 3,
        success: 0.40,
        fail: 0.60,
        destroy: 0,
        cost: 55832200
    }, {
        level: 4,
        success: 0.40,
        fail: 0.60,
        destroy: 0,
        cost: 55832200
    }, {
        level: 5,
        success: 0.40,
        fail: 0.582,
        destroy: 0.018,
        cost: 55832200
    }, {
        level: 6,
        success: 0.40,
        fail: 0.57,
        destroy: 0.03,
        cost: 55832200
    }, {
        level: 7,
        success: 0.40,
        fail: 0.558,
        destroy: 0.042,
        cost: 55832200
    }, {
        level: 8,
        success: 0.40,
        fail: 0.54,
        destroy: 0.06,
        cost: 55832200
    }, {
        level: 9,
        success: 0.37,
        fail: 0.535,
        destroy: 0.095,
        cost: 55832200
    }, {
        level: 10,
        success: 0.35,
        fail: 0.52,
        destroy: 0.13,
        cost: 55832200
    }, {
        level: 11,
        success: 0.35,
        fail: 0.487,
        destroy: 0.163,
        cost: 55832200
    }, {
        level: 12,
        success: 0.03,
        fail: 0.485,
        destroy: 0.485,
        cost: 55832200
    }, {
        level: 13,
        success: 0.02,
        fail: 0.49,
        destroy: 0.49,
        cost: 55832200
    }, {
        level: 14,
        success: 0.01,
        fail: 0.495,
        destroy: 0.495,
        cost: 55832200
    }]
};
</script>