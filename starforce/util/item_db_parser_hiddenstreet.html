<style>
    .hidden {
        display: none !important;
    }
</style>
<pre>
        Attempt to parse Hidden Street tables for item data. Example of page to use: <a href="https://www.hidden-street.net/gms/equipment/armour/cape">https://www.hidden-street.net/gms/equipment/armour/cape</a>
        To use this page, go to item set pages like the ones above, open up the Inspect Element tab (F12 for Chrome and Firefox, tab "Elements" in Chrome and "Inspector" in Firefox),
    right click on the outer-most tag (html tag) and click "Edit as HTML". Copy all contents into the textbox provided below and hit "Get Items".
</pre>

<textarea id="text" style="width:100%;height:300px"></textarea>
<textarea id="textOutput" style="width:100%;height:300px" class="hidden"></textarea>
<button id="parse">Get Items</button>

<div id="output"></div>


<script
  src="https://code.jquery.com/jquery-3.4.1.min.js"
  integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
  crossorigin="anonymous"></script>

<script src="parser.js"></script>

<script>
    $(function() {
        $("#parse").on("click", async function(){
            let items = {};

            /* get the wiki page as a dom fragment */
            let dom = $($("#text").val());

            /* get the item tables */
            let tables = dom.find(".database-info");

            for (let i = 0; i < tables.length; ++i) {
                let table = tables.eq(i);

                let _item = await extract_item_data(table);

                debugger
            }

            let sItems = JSON.stringify(items);
            $("#textOutput").removeClass("hidden").val(sItems);

            $("#output").html(`
                Completed. <br>
                Copy the stringified json into <a href="https://beautifier.io/" target="_BLANK">https://beautifier.io/</a> to get a pretty json.
                <hr>
                <span style="color:red">
                    Issues: <br>
                    For bows/crossbows - check knockback rate stat (key = knockback) as it is not part of the table <br>
                    For xenon weapons - check if it's for pirate or thief and change job parameter as necessary <br>
                    If item gives % max hp, change the hp stat to p_hp stat
                </span>
            `);
        });

        var download_image = function(url, name){
            return new Promise((res, rej)=>{
                fetch(url)
                    .then(resp => resp.blob())
                    .then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        let ext = blob.type.replace("image/","");
                        a.style.display = 'none';
                        a.href = url;
                        // the filename you want
                        a.download = name;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        res(ext);
                    })
                    .catch(() => alert('An error sorry'));
            })
        }
                
        let extract_item_data = async function(td) {
            let t = Object.assign({}, item_template);

            /* column 1 - PICTURE AND NAME */
            let td_name = td.eq(0);
            t.name = td_name.find("a").text().trim();
            let img = td.find(".image").attr("href").replace(/(\/revision\/latest\?cb=(.*))/,"");
            let img_name = t.name.replace(regex_removespecialchar, "");
            t.img_type = await download_image(img, img_name);

            /* column 2 - TYPE */
            let td_type = td.eq(1);
            let type = td_type.find("a").text().trim().toLowerCase();
            t.class = is_armor(type) ? "armor" : "weapon";
            t.type = type;

            if (t.type == "pocket item") {
                t.type = "pocket";
            } else if (t.type == "android heart") {
                t.type = "mechanical heart";
            }

            t.img = `item-${t.name.replace(regex_removespecialchar,"").toLowerCase()}`;

            /* column 3 - REQUIREMENT */
            let td_requirements = td.eq(2);
            let req_array = td_requirements.html().trim().split("<br>");

            let has_job_req = false;
            t.req = {
                str: 0,
                dex: 0,
                int: 0,
                luk: 0
            };

            let this_job = "";

            for (let i = 0; i < req_array.length; ++i) {
                let req_item = req_array[i].toLowerCase();

                if (req_item.includes("level")) {
                    let [level_legend, level] = req_item.split(" ");
                    t.level = +level;
                } else if (req_item.includes("job")) { 
                    t.job = [].concat();
                    let [job_legend, job] = req_item.split(":");
                    job = job.toLowerCase().trim();
                    if (job.includes("</a>")) {
                        let pre_job = $(job).text().trim();
                        this_job = get_jobs(pre_job.toLowerCase());
                    } else {
                        this_job = get_jobs(job);
                    }
                    t.job.push(this_job.trim());
                } else { /* else is a stat requirement */    
                    let [req_stat, req_val] = req_item.replace(":", "").split(" ");
                    t.req[req_stat] = +req_val;
                }
            }

            if (t.job.length === 0) {
                t.job = ["beginner", "warrior", "bowman", "magician", "thief", "pirate"];
            }

            if (this_job != "") {
                t.pstat = p_stat[this_job];
                t.mstat = m_stat[this_job];  
            } else {
                t.pstat = ["str", "dex", "int", "luk"];
            }

            if (this_job === "magician") {
                t.att_type = "matt";
            } else {
                t.att_type = "watt";
            } 

            /* column 4 - EFFECTS  */
            let td_effects = td.eq(3);
            let effects = td_effects.html().trim().split("<br>");
            t.bstat = {};
            for (let i = 0; i < effects.length; ++i) {
                if (!effects[i].includes(":")) {
                    effects[i] = effects[i].replace("+", ": +");
                }

                let [_effect, effect_val] = effects[i].split(":");
                let effect = _effect.toLowerCase().trim().replace(regex_removespecialchar, "");
                let rstat = resolve_stat(effect);
                
                if (rstat !== "") {
                    var isPercent = false;
                    if (effect_val.includes("%")) {
                        isPercent = true;
                    }

                    t.bstat[rstat] = +effect_val.replace("+", "").replace("%", "").trim();

                    if (isPercent) {
                        t.bstat[rstat] /= 100;
                    }
                }

                if (effect === "attackspeed") {
                    t.speed = effect_val.replace(/\(.*\)/,"").trim().toLowerCase();
                }

                if (effect === "allstats") {
                    ["str", "dex", "int", "luk"].forEach((a)=>{
                        t.bstat[a] = +effect_val.replace("+", "").trim();
                    });
                }
            }
            t.upgrades = upgrades[t.type] || 0;
            if (t.upgrades > 0) {
                t.hammers_added = 2;
            }

            if (["ring"].includes(t.type)) {
                t.enhanceable = false;
                t.flame_type = 0;
            } else if (["shoulder"].includes(t.type)) {
                t.flame_type = 0;
            } else if (["face accessory", "eye accessory"].includes(t.type)) {
                t.sub_class = "accessory";
            } else if (t.type === "totem") {
                t.enhanceable = false;
                t.flame_type = 0;
                t.scrollable = false;
                t.starforce = false;
            }

            return t;
        }
    });
</script>